<launch>
    <arg name="database_path" default="~/.ros/rtabmap.db"/>
    
    <group ns="rtabmap">
        <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="--delete_db_on_start">
            
            <!-- Input topics -->
            <remap from="rgb/image"       to="/camera/color/image_raw"/>
            <remap from="depth/image"     to="/camera/depth/image_raw"/>
            <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
            <remap from="depth/camera_info" to="/camera/depth/camera_info"/>
            <remap from="scan"            to="/scan"/>
            <remap from="odom"            to="/odom"/>
            
            <!-- Frame IDs -->
            <param name="frame_id" type="string" value="base_link"/>
            <param name="odom_frame_id" type="string" value="odom"/>
            <param name="map_frame_id" type="string" value="map"/>
            
            <!-- Subscriptions -->
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="subscribe_rgb" type="bool" value="true"/>
            
            <!-- Synchronization -->
            <param name="topic_queue_size" type="int" value="50"/>
            <param name="sync_queue_size" type="int" value="50"/>
            <param name="approx_sync" type="bool" value="true"/>
            <param name="approx_sync_max_interval" type="double" value="0.5"/>
            
            <!-- RTAB-Map Parameters -->
            <param name="Rtabmap/DetectionRate" type="string" value="1"/>
            <param name="RGBD/ProximityBySpace" type="string" value="true"/>
            <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/>
            <param name="RGBD/AngularUpdate" type="string" value="0.1"/>
            <param name="RGBD/LinearUpdate" type="string" value="0.1"/>
            
            <!-- Memory Management -->
            <param name="Mem/IncrementalMemory" type="string" value="true"/>
            <param name="Mem/InitWMWithAllNodes" type="string" value="false"/>
            
            <!-- Loop Closure -->
            <param name="Kp/MaxDepth" type="string" value="50.0"/>
            <param name="Kp/DetectorStrategy" type="string" value="6"/>
            <param name="Vis/MinInliers" type="string" value="12"/>
            <param name="Vis/InlierDistance" type="string" value="0.1"/>
            
            <!-- 2D Mode -->
            <param name="Reg/Force3DoF" type="string" value="true"/>
            
            <!-- Optimization -->
            <param name="Optimizer/Strategy" type="string" value="0"/>
            <param name="RGBD/OptimizeMaxError" type="string" value="3.0"/>
            
            <!-- CRITICAL CHANGES FOR DENSE MAPPING -->
            <param name="Grid/FromDepth" type="string" value="true"/>
            <param name="Grid/3D" type="string" value="true"/>              <!-- CHANGED: false -> true -->
            <param name="Grid/RayTracing" type="string" value="true"/>
            <param name="Grid/CellSize" type="string" value="0.05"/>         <!-- CHANGED: 0.1 -> 0.05 -->
            <param name="Grid/RangeMax" type="string" value="10.0"/>         <!-- CHANGED: 50 -> 10 -->
            <param name="Grid/RangeMin" type="string" value="0.2"/>          <!-- NEW -->
            <param name="Grid/DepthDecimation" type="string" value="1"/>     <!-- NEW: Use all depth pixels -->
            <param name="Grid/GroundIsObstacle" type="string" value="false"/><!-- NEW: Don't mark floor as obstacle -->
            <param name="Grid/MaxGroundHeight" type="string" value="0.1"/>   <!-- NEW -->
            <param name="Grid/MaxObstacleHeight" type="string" value="3.0"/> <!-- NEW -->
            <param name="Grid/NoiseFilteringRadius" type="string" value="0"/><!-- NEW: Disable noise filter -->
            <param name="Grid/ClusterRadius" type="string" value="0.1"/>     <!-- NEW -->
            
            <!-- Publishing -->
            <param name="publish_tf" type="bool" value="true"/>
            <param name="wait_for_transform" type="bool" value="false"/>
            <param name="wait_for_transform_duration" type="double" value="0.5"/>
        </node>
        
        <!-- RTAB-Map Visualization -->
        <node pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmapviz" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="frame_id" type="string" value="base_link"/>
            <!-- Enable 3D point cloud publishing -->
<!-- <param name="cloud_output_voxelized" type="bool" value="true"/>
<param name="cloud_voxel_size" type="double" value="0.05"/>
<param name="Grid/MaxObstacleHeight" type="string" value="5.0"/> -->

            
            <!-- Sync parameters -->
            <param name="topic_queue_size" type="int" value="50"/>
            <param name="sync_queue_size" type="int" value="50"/>
            <param name="approx_sync" type="bool" value="true"/>
            <param name="approx_sync_max_interval" type="double" value="0.5"/>
            
            <remap from="rgb/image" to="/camera/color/image_raw"/>
            <remap from="depth/image" to="/camera/depth/image_raw"/>
            <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
            <remap from="scan" to="/scan"/>
            <remap from="odom" to="/odom"/>
        </node>
    </group>
</launch>
